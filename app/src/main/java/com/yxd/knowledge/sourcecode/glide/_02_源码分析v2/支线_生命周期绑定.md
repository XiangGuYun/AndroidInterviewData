# Glide生命周期绑定

## 生命周期绑定

### 思考🤔
在Glide.with中，传入的是一个Activity，Glide会持有了Activity的引用，

那么当Activity销毁后，Glide的线程池如果仍在运行，会造成内存泄漏吗？

> 不会造成内存泄漏。
> 
> >Glide会创建一个空白的fragment依附在Activity上，来监听它的生命周期。
> >当activity销毁时会自动处理资源回收问题。

![](img/ca843e4f.png)

<br>

## 生命周期作用域

### 思考🤔
Glide.with()为什么会有那么多重载方法？

![](img/d51c54a7.png)

> 传入不同的参数，Glide的生命周期作用域会不一样。
> 
> 如果是在子线程中创建，无论什么参数，作用域都同于Application。
> 
> 如果在主线程中创建：
> 
> 1. View: Activity/Fragment
> 2. Fragment：Fragment
> 3. Activity：Activity
> 4. Service的Context/Application：Application

### 生命周期作用域

#### 在子线程中调用Glide
子线程中不能创建fragment，无法做生命周期管理。

如果引用Activity可能会造成内存泄漏，所以只能使用全局Context。

``` java
class ApplicationLifecycle implements Lifecycle {
  @Override
  public void addListener(@NonNull LifecycleListener listener) {
    listener.onStart();
  }

  @Override
  public void removeListener(@NonNull LifecycleListener listener) {
    // Do nothing.
  }
}
```

## 源码分析

#### RequestManagerRetriever.java
``` java
@NonNull
public RequestManager get(@NonNull FragmentActivity activity) {
    if (Util.isOnBackgroundThread()) {
      // 如果在子线程，则使用全局context，同时会将失去生命周期管理
      return get(activity.getApplicationContext());
    } else {
      // ...
      return supportFragmentGet(activity, fm, /*parentHint=*/ null, isActivityVisible(activity));
    }
}
```

``` java
  @NonNull
private RequestManager supportFragmentGet(
    @NonNull Context context,
    @NonNull FragmentManager fm,
    @Nullable Fragment parentHint,
    boolean isParentVisible) {
      
    // current是一个空白的fragment 
    SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);
    RequestManager requestManager = current.getRequestManager();
    // requestManager不会重复创建
    if (requestManager == null) {
】      Glide glide = Glide.get(context);
      requestManager =
          factory.build(
              glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);
      if (isParentVisible) {
        requestManager.onStart();
      }
      current.setRequestManager(requestManager);
    }
    return requestManager;
}
```